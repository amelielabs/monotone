init
set workers to 0
set interval to 10
set serial to false
set uuid to '00000000-0000-0000-0000-000000000000'
open
# test: drop parsing
drop
error: DROP <STORAGE|PARTITION|PARTITIONS> expected
drop abc
error: DROP <STORAGE|PARTITION|PARTITIONS> expected
drop partition
error: DROP PARTITION <id>
drop partition abc
error: DROP PARTITION <id>
# test: drop partition does not exists
drop partition 0
error: drop: partition <0> not found
# test: drop partition if exists
drop partition if exists 0
# test: create partition (no file)
insert 0
insert 1
insert 2
show partitions debug
[{
  "min": 0,
  "max": 10,
  "events": 3,
  "events_heap": 3,
  "regions": 0,
  "size": 0,
  "size_uncompressed": 0,
  "size_heap": 2097152,
  "on_storage": false,
  "on_cloud": false,
  "storage": "main",
  "index": null
}]
# test: drop
drop partition 0
show partitions debug
[]
# test: create partition
insert 0
insert 1
insert 2
refresh partition 0
show partitions debug
[{
  "min": 0,
  "max": 10,
  "events": 3,
  "events_heap": 0,
  "regions": 1,
  "size": 234,
  "size_uncompressed": 234,
  "size_heap": 0,
  "on_storage": true,
  "on_cloud": false,
  "storage": "main",
  "index": {
    "size": 159,
    "size_regions": 75,
    "size_regions_origin": 75,
    "regions": 1,
    "events": 3,
    "lsn": 7,
    "compression": 0
  }
}]
# test: drop #2
drop partition 0
show partitions debug
[]
show storages debug
{
  "main": {
    "config": {
      "uuid": "(filtered)",
      "name": "main",
      "path": "",
      "cloud": "",
      "sync": true,
      "crc": false,
      "compression": "",
      "refresh_wm": 41943040,
      "region_size": 131072
    },
    "stats": {
      "min": -1,
      "max": 0,
      "partitions": 0,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 0,
      "events_heap": 0,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 0
    }
  }
}
# test: create partitions
insert 10
insert 20
insert 30
insert 40
show partitions debug
[{
  "min": 10,
  "max": 20,
  "events": 1,
  "events_heap": 1,
  "regions": 0,
  "size": 0,
  "size_uncompressed": 0,
  "size_heap": 2097152,
  "on_storage": false,
  "on_cloud": false,
  "storage": "main",
  "index": null
}, {
  "min": 20,
  "max": 30,
  "events": 1,
  "events_heap": 1,
  "regions": 0,
  "size": 0,
  "size_uncompressed": 0,
  "size_heap": 2097152,
  "on_storage": false,
  "on_cloud": false,
  "storage": "main",
  "index": null
}, {
  "min": 30,
  "max": 40,
  "events": 1,
  "events_heap": 1,
  "regions": 0,
  "size": 0,
  "size_uncompressed": 0,
  "size_heap": 2097152,
  "on_storage": false,
  "on_cloud": false,
  "storage": "main",
  "index": null
}, {
  "min": 40,
  "max": 50,
  "events": 1,
  "events_heap": 1,
  "regions": 0,
  "size": 0,
  "size_uncompressed": 0,
  "size_heap": 2097152,
  "on_storage": false,
  "on_cloud": false,
  "storage": "main",
  "index": null
}]
# test: drop partitions parsing
drop partitions
error: DROP PARTITIONS <FROM> min TO max
drop partitions abc
error: DROP PARTITIONS <FROM> min TO max
drop partitions from
error: DROP PARTITIONS FROM <min> TO max
drop partitions from abc
error: DROP PARTITIONS FROM <min> TO max
drop partitions from 0
error: DROP PARTITIONS FROM min <TO> max
drop partitions from 0 to
error: DROP PARTITIONS FROM min TO <max>
drop partitions from 0 to abc
error: DROP PARTITIONS FROM min TO <max>
# test: drop partitions
drop partitions from 0 to 50
show partitions debug
[]
# test: drop partitions (gap)
insert 100
insert 200
insert 300
insert 400
show partitions debug
[{
  "min": 100,
  "max": 110,
  "events": 1,
  "events_heap": 1,
  "regions": 0,
  "size": 0,
  "size_uncompressed": 0,
  "size_heap": 2097152,
  "on_storage": false,
  "on_cloud": false,
  "storage": "main",
  "index": null
}, {
  "min": 200,
  "max": 210,
  "events": 1,
  "events_heap": 1,
  "regions": 0,
  "size": 0,
  "size_uncompressed": 0,
  "size_heap": 2097152,
  "on_storage": false,
  "on_cloud": false,
  "storage": "main",
  "index": null
}, {
  "min": 300,
  "max": 310,
  "events": 1,
  "events_heap": 1,
  "regions": 0,
  "size": 0,
  "size_uncompressed": 0,
  "size_heap": 2097152,
  "on_storage": false,
  "on_cloud": false,
  "storage": "main",
  "index": null
}, {
  "min": 400,
  "max": 410,
  "events": 1,
  "events_heap": 1,
  "regions": 0,
  "size": 0,
  "size_uncompressed": 0,
  "size_heap": 2097152,
  "on_storage": false,
  "on_cloud": false,
  "storage": "main",
  "index": null
}]
show storages debug
{
  "main": {
    "config": {
      "uuid": "(filtered)",
      "name": "main",
      "path": "",
      "cloud": "",
      "sync": true,
      "crc": false,
      "compression": "",
      "refresh_wm": 41943040,
      "region_size": 131072
    },
    "stats": {
      "min": 100,
      "max": 410,
      "partitions": 4,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 4,
      "events_heap": 4,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 8388608
    }
  }
}
# test: drop partitions
drop partitions from 0 to 500
show partitions debug
[]
show storages debug
{
  "main": {
    "config": {
      "uuid": "(filtered)",
      "name": "main",
      "path": "",
      "cloud": "",
      "sync": true,
      "crc": false,
      "compression": "",
      "refresh_wm": 41943040,
      "region_size": 131072
    },
    "stats": {
      "min": -1,
      "max": 0,
      "partitions": 0,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 0,
      "events_heap": 0,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 0
    }
  }
}
close
