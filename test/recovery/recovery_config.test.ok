# test: open/close
init
set workers to 0
set workers_upload to 0
set interval to 10
set uuid to 'c14fb1d4-d1f7-5bf1-f256-4ad89bc47379'
set serial to false
open
files
wal
config.json
log
c14fb1d4-d1f7-5bf1-f256-4ad89bc47379
close
# test: open
init
set workers to 0
set workers_upload to 0
set interval to 10
open
show all
{
  "version": "0.0",
  "uuid": "c14fb1d4-d1f7-5bf1-f256-4ad89bc47379",
  "online": true,
  "directory": "_output",
  "log_enable": true,
  "log_to_file": true,
  "log_to_stdout": false,
  "serial": false,
  "interval": 10,
  "workers": 0,
  "workers_upload": 0,
  "wal_enable": true,
  "wal_rotate_wm": 104857600,
  "wal_sync_on_rotate": true,
  "wal_sync_on_write": false,
  "ssn": 0,
  "lsn": 0
}
show storages debug
{
  "main": {
    "config": {
      "uuid": "(filtered)",
      "name": "main",
      "path": "",
      "cloud": "",
      "cloud_drop_local": true,
      "sync": true,
      "crc": false,
      "refresh_wm": 41943040,
      "region_size": 131072,
      "compression": "",
      "compression_level": 0,
      "encryption": ""
    },
    "stats": {
      "min": -1,
      "max": 0,
      "partitions": 0,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 0,
      "events_heap": 0,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 0
    }
  }
}
files
wal
config.json
log
c14fb1d4-d1f7-5bf1-f256-4ad89bc47379
# test: create storage
create storage test (sync false)
show storages debug
{
  "main": {
    "config": {
      "uuid": "(filtered)",
      "name": "main",
      "path": "",
      "cloud": "",
      "cloud_drop_local": true,
      "sync": true,
      "crc": false,
      "refresh_wm": 41943040,
      "region_size": 131072,
      "compression": "",
      "compression_level": 0,
      "encryption": ""
    },
    "stats": {
      "min": -1,
      "max": 0,
      "partitions": 0,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 0,
      "events_heap": 0,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 0
    }
  },
  "test": {
    "config": {
      "uuid": "(filtered)",
      "name": "test",
      "path": "",
      "cloud": "",
      "cloud_drop_local": true,
      "sync": false,
      "crc": false,
      "refresh_wm": 41943040,
      "region_size": 131072,
      "compression": "",
      "compression_level": 0,
      "encryption": ""
    },
    "stats": {
      "min": -1,
      "max": 0,
      "partitions": 0,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 0,
      "events_heap": 0,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 0
    }
  }
}
# test: close/open
close
init
open
# test: ensure storage exists
show storages debug
{
  "main": {
    "config": {
      "uuid": "(filtered)",
      "name": "main",
      "path": "",
      "cloud": "",
      "cloud_drop_local": true,
      "sync": true,
      "crc": false,
      "refresh_wm": 41943040,
      "region_size": 131072,
      "compression": "",
      "compression_level": 0,
      "encryption": ""
    },
    "stats": {
      "min": -1,
      "max": 0,
      "partitions": 0,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 0,
      "events_heap": 0,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 0
    }
  },
  "test": {
    "config": {
      "uuid": "(filtered)",
      "name": "test",
      "path": "",
      "cloud": "",
      "cloud_drop_local": true,
      "sync": false,
      "crc": false,
      "refresh_wm": 41943040,
      "region_size": 131072,
      "compression": "",
      "compression_level": 0,
      "encryption": ""
    },
    "stats": {
      "min": -1,
      "max": 0,
      "partitions": 0,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 0,
      "events_heap": 0,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 0
    }
  }
}
# test: alter storage
alter storage test set (compression 'zstd')
# test: close/open
close
init
open
# test: validate storage settings
show storages debug
{
  "main": {
    "config": {
      "uuid": "(filtered)",
      "name": "main",
      "path": "",
      "cloud": "",
      "cloud_drop_local": true,
      "sync": true,
      "crc": false,
      "refresh_wm": 41943040,
      "region_size": 131072,
      "compression": "",
      "compression_level": 0,
      "encryption": ""
    },
    "stats": {
      "min": -1,
      "max": 0,
      "partitions": 0,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 0,
      "events_heap": 0,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 0
    }
  },
  "test": {
    "config": {
      "uuid": "(filtered)",
      "name": "test",
      "path": "",
      "cloud": "",
      "cloud_drop_local": true,
      "sync": false,
      "crc": false,
      "refresh_wm": 41943040,
      "region_size": 131072,
      "compression": "zstd",
      "compression_level": 0,
      "encryption": ""
    },
    "stats": {
      "min": -1,
      "max": 0,
      "partitions": 0,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 0,
      "events_heap": 0,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 0
    }
  }
}
# test: alter storage rename
alter storage test rename to test2
show storages debug
{
  "main": {
    "config": {
      "uuid": "(filtered)",
      "name": "main",
      "path": "",
      "cloud": "",
      "cloud_drop_local": true,
      "sync": true,
      "crc": false,
      "refresh_wm": 41943040,
      "region_size": 131072,
      "compression": "",
      "compression_level": 0,
      "encryption": ""
    },
    "stats": {
      "min": -1,
      "max": 0,
      "partitions": 0,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 0,
      "events_heap": 0,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 0
    }
  },
  "test2": {
    "config": {
      "uuid": "(filtered)",
      "name": "test2",
      "path": "",
      "cloud": "",
      "cloud_drop_local": true,
      "sync": false,
      "crc": false,
      "refresh_wm": 41943040,
      "region_size": 131072,
      "compression": "zstd",
      "compression_level": 0,
      "encryption": ""
    },
    "stats": {
      "min": -1,
      "max": 0,
      "partitions": 0,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 0,
      "events_heap": 0,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 0
    }
  }
}
# test: close/open
close
init
open
# test: validate storage settings
show storages debug
{
  "main": {
    "config": {
      "uuid": "(filtered)",
      "name": "main",
      "path": "",
      "cloud": "",
      "cloud_drop_local": true,
      "sync": true,
      "crc": false,
      "refresh_wm": 41943040,
      "region_size": 131072,
      "compression": "",
      "compression_level": 0,
      "encryption": ""
    },
    "stats": {
      "min": -1,
      "max": 0,
      "partitions": 0,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 0,
      "events_heap": 0,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 0
    }
  },
  "test2": {
    "config": {
      "uuid": "(filtered)",
      "name": "test2",
      "path": "",
      "cloud": "",
      "cloud_drop_local": true,
      "sync": false,
      "crc": false,
      "refresh_wm": 41943040,
      "region_size": 131072,
      "compression": "zstd",
      "compression_level": 0,
      "encryption": ""
    },
    "stats": {
      "min": -1,
      "max": 0,
      "partitions": 0,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 0,
      "events_heap": 0,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 0
    }
  }
}
# test: drop storage
drop storage test2
show storages debug
{
  "main": {
    "config": {
      "uuid": "(filtered)",
      "name": "main",
      "path": "",
      "cloud": "",
      "cloud_drop_local": true,
      "sync": true,
      "crc": false,
      "refresh_wm": 41943040,
      "region_size": 131072,
      "compression": "",
      "compression_level": 0,
      "encryption": ""
    },
    "stats": {
      "min": -1,
      "max": 0,
      "partitions": 0,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 0,
      "events_heap": 0,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 0
    }
  }
}
# test: close/open
close
init
open
# test: ensure storage does not exists
show storages debug
{
  "main": {
    "config": {
      "uuid": "(filtered)",
      "name": "main",
      "path": "",
      "cloud": "",
      "cloud_drop_local": true,
      "sync": true,
      "crc": false,
      "refresh_wm": 41943040,
      "region_size": 131072,
      "compression": "",
      "compression_level": 0,
      "encryption": ""
    },
    "stats": {
      "min": -1,
      "max": 0,
      "partitions": 0,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 0,
      "events_heap": 0,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 0
    }
  }
}
# test: create cloud
create cloud mock (type 'mock')
show clouds
{
  "mock": {
    "name": "mock",
    "type": "mock",
    "login": "",
    "password": "(secret)",
    "url": "",
    "debug": false
  }
}
# test: close/open
close
init
open
# test: ensure cloud exists
show clouds
{
  "mock": {
    "name": "mock",
    "type": "mock",
    "login": "",
    "password": "(secret)",
    "url": "",
    "debug": false
  }
}
# test: alter cloud
alter cloud mock set (url 'localhost')
# test: close/open
close
init
open
# test: validate cloud settings
show clouds
{
  "mock": {
    "name": "mock",
    "type": "mock",
    "login": "",
    "password": "(secret)",
    "url": "localhost",
    "debug": false
  }
}
# test: alter cloud rename
alter cloud mock rename to mock2
show clouds
{
  "mock2": {
    "name": "mock2",
    "type": "mock",
    "login": "",
    "password": "(secret)",
    "url": "localhost",
    "debug": false
  }
}
# test: close/open
close
init
open
# test: validate storage settings
show clouds
{
  "mock2": {
    "name": "mock2",
    "type": "mock",
    "login": "",
    "password": "(secret)",
    "url": "localhost",
    "debug": false
  }
}
# test: drop cloud
drop cloud mock2
show clouds
{
}
# test: close/open
close
init
open
# test: ensure cloud does not exists
show clouds
{
}
# test: create storage with cloud
create cloud mock (type 'mock')
show clouds
{
  "mock": {
    "name": "mock",
    "type": "mock",
    "login": "",
    "password": "(secret)",
    "url": "",
    "debug": false
  }
}
create storage test (cloud 'mock', sync false)
show storages debug
{
  "main": {
    "config": {
      "uuid": "(filtered)",
      "name": "main",
      "path": "",
      "cloud": "",
      "cloud_drop_local": true,
      "sync": true,
      "crc": false,
      "refresh_wm": 41943040,
      "region_size": 131072,
      "compression": "",
      "compression_level": 0,
      "encryption": ""
    },
    "stats": {
      "min": -1,
      "max": 0,
      "partitions": 0,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 0,
      "events_heap": 0,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 0
    }
  },
  "test": {
    "config": {
      "uuid": "(filtered)",
      "name": "test",
      "path": "",
      "cloud": "mock",
      "cloud_drop_local": true,
      "sync": false,
      "crc": false,
      "refresh_wm": 41943040,
      "region_size": 131072,
      "compression": "",
      "compression_level": 0,
      "encryption": ""
    },
    "stats": {
      "min": -1,
      "max": 0,
      "partitions": 0,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 0,
      "events_heap": 0,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 0
    }
  }
}
# test: close/open
close
init
open
# test: ensure storage exists
show storages debug
{
  "main": {
    "config": {
      "uuid": "(filtered)",
      "name": "main",
      "path": "",
      "cloud": "",
      "cloud_drop_local": true,
      "sync": true,
      "crc": false,
      "refresh_wm": 41943040,
      "region_size": 131072,
      "compression": "",
      "compression_level": 0,
      "encryption": ""
    },
    "stats": {
      "min": -1,
      "max": 0,
      "partitions": 0,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 0,
      "events_heap": 0,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 0
    }
  },
  "test": {
    "config": {
      "uuid": "(filtered)",
      "name": "test",
      "path": "",
      "cloud": "mock",
      "cloud_drop_local": true,
      "sync": false,
      "crc": false,
      "refresh_wm": 41943040,
      "region_size": 131072,
      "compression": "",
      "compression_level": 0,
      "encryption": ""
    },
    "stats": {
      "min": -1,
      "max": 0,
      "partitions": 0,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 0,
      "events_heap": 0,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 0
    }
  }
}
# test: drop storage
drop storage test
show storages debug
{
  "main": {
    "config": {
      "uuid": "(filtered)",
      "name": "main",
      "path": "",
      "cloud": "",
      "cloud_drop_local": true,
      "sync": true,
      "crc": false,
      "refresh_wm": 41943040,
      "region_size": 131072,
      "compression": "",
      "compression_level": 0,
      "encryption": ""
    },
    "stats": {
      "min": -1,
      "max": 0,
      "partitions": 0,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 0,
      "events_heap": 0,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 0
    }
  }
}
# test: close/open
close
init
open
# test: ensure storage does not exists
show storages debug
{
  "main": {
    "config": {
      "uuid": "(filtered)",
      "name": "main",
      "path": "",
      "cloud": "",
      "cloud_drop_local": true,
      "sync": true,
      "crc": false,
      "refresh_wm": 41943040,
      "region_size": 131072,
      "compression": "",
      "compression_level": 0,
      "encryption": ""
    },
    "stats": {
      "min": -1,
      "max": 0,
      "partitions": 0,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 0,
      "events_heap": 0,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 0
    }
  }
}
# test: alter set pipeline
alter pipeline set main (partitions 0)
show pipeline
[{
  "name": "main",
  "partitions": 0,
  "size": -1,
  "events": -1,
  "duration": -1
}]
# test: close/open
close
init
open
# test: ensure pipeline settings remain
show pipeline
[{
  "name": "main",
  "partitions": 0,
  "size": -1,
  "events": -1,
  "duration": -1
}]
show storages debug
{
  "main": {
    "config": {
      "uuid": "(filtered)",
      "name": "main",
      "path": "",
      "cloud": "",
      "cloud_drop_local": true,
      "sync": true,
      "crc": false,
      "refresh_wm": 41943040,
      "region_size": 131072,
      "compression": "",
      "compression_level": 0,
      "encryption": ""
    },
    "stats": {
      "min": -1,
      "max": 0,
      "partitions": 0,
      "partitions_local": 0,
      "partitions_cloud": 0,
      "regions": 0,
      "events": 0,
      "events_heap": 0,
      "size": 0,
      "size_uncompressed": 0,
      "size_heap": 0
    }
  }
}
close
