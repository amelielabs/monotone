init
set workers to 0
set interval to 10
set serial to false
set uuid to '00000000-0000-0000-0000-000000000000'
open
# test: create wal on start
show wal
{
  "lsn": 0,
  "lsn_min": 1,
  "files": 1
}
# test: restart
close
init
set workers to 0
set interval to 10
open
show wal
{
  "lsn": 0,
  "lsn_min": 1,
  "files": 1
}
# test: insert
insert 1
show lsn
1
show wal
{
  "lsn": 1,
  "lsn_min": 1,
  "files": 1
}
debug 'wal_read'
[1, 0, 1, 30]

insert 2
show lsn
2
show wal
{
  "lsn": 2,
  "lsn_min": 1,
  "files": 1
}
debug 'wal_read'
[1, 0, 1, 30]
[2, 0, 1, 30]

insert 3
show lsn
3
show wal
{
  "lsn": 3,
  "lsn_min": 1,
  "files": 1
}
debug 'wal_read'
[1, 0, 1, 30]
[2, 0, 1, 30]
[3, 0, 1, 30]

# test: restart
close
init
set workers to 0
set interval to 10
open
show lsn
3
show wal
{
  "lsn": 3,
  "lsn_min": 1,
  "files": 1
}
debug 'wal_read'
[1, 0, 1, 30]
[2, 0, 1, 30]
[3, 0, 1, 30]

# test: select
select
[1]
[2]
[3]
(eof)
# test: create wal
debug 'wal_create'
show wal
{
  "lsn": 3,
  "lsn_min": 1,
  "files": 2
}
# test: restart (empty wal file)
close
init
set workers to 0
set interval to 10
open
# test: select
show wal
{
  "lsn": 3,
  "lsn_min": 1,
  "files": 2
}
select
[1]
[2]
[3]
(eof)
# test: insert #2
insert 4
show lsn
4
show wal
{
  "lsn": 4,
  "lsn_min": 1,
  "files": 2
}
debug 'wal_read'
[1, 0, 1, 30]
[2, 0, 1, 30]
[3, 0, 1, 30]
[4, 0, 1, 30]

# test: restart
close
init
set workers to 0
set interval to 10
open
# test: select
show wal
{
  "lsn": 4,
  "lsn_min": 1,
  "files": 2
}
select
[1]
[2]
[3]
[4]
(eof)
# test: gc (still in heap)
debug 'wal_gc'
show wal
{
  "lsn": 4,
  "lsn_min": 1,
  "files": 2
}
# test: refresh
show partitions debug
[{
  "min": 0,
  "max": 10,
  "created": "(filtered)",
  "events": 4,
  "events_heap": 4,
  "regions": 0,
  "size": 0,
  "size_uncompressed": 0,
  "size_heap": 2097152,
  "on_storage": false,
  "on_cloud": false,
  "storage": "main",
  "index": null
}]
refresh partition 0
show partitions debug
[{
  "min": 0,
  "max": 10,
  "created": "(filtered)",
  "events": 4,
  "events_heap": 0,
  "regions": 1,
  "size": 280,
  "size_uncompressed": 280,
  "size_heap": 0,
  "on_storage": true,
  "on_cloud": false,
  "storage": "main",
  "index": {
    "size": 74,
    "size_origin": 74,
    "size_regions": 92,
    "size_regions_origin": 92,
    "size_total": 280,
    "size_total_origin": 280,
    "regions": 1,
    "events": 4,
    "lsn": 4,
    "compression": 0
  }
}]
show wal
{
  "lsn": 4,
  "lsn_min": 1,
  "files": 2
}
# test: restart
close
init
set workers to 0
set interval to 10
open
# test: ensure no heap used
show partitions debug
[{
  "min": 0,
  "max": 10,
  "created": "(filtered)",
  "events": 4,
  "events_heap": 0,
  "regions": 1,
  "size": 280,
  "size_uncompressed": 280,
  "size_heap": 0,
  "on_storage": true,
  "on_cloud": false,
  "storage": "main",
  "index": {
    "size": 74,
    "size_origin": 74,
    "size_regions": 92,
    "size_regions_origin": 92,
    "size_total": 280,
    "size_total_origin": 280,
    "regions": 1,
    "events": 4,
    "lsn": 4,
    "compression": 0
  }
}]
# test: select
select
[1]
[2]
[3]
[4]
(eof)
# test: gc
debug 'wal_gc'
show wal
{
  "lsn": 4,
  "lsn_min": 4,
  "files": 1
}
# test: restart
close
init
set workers to 0
set interval to 10
open
# test: select
show partitions debug
[{
  "min": 0,
  "max": 10,
  "created": "(filtered)",
  "events": 4,
  "events_heap": 0,
  "regions": 1,
  "size": 280,
  "size_uncompressed": 280,
  "size_heap": 0,
  "on_storage": true,
  "on_cloud": false,
  "storage": "main",
  "index": {
    "size": 74,
    "size_origin": 74,
    "size_regions": 92,
    "size_regions_origin": 92,
    "size_total": 280,
    "size_total_origin": 280,
    "regions": 1,
    "events": 4,
    "lsn": 4,
    "compression": 0
  }
}]
show wal
{
  "lsn": 4,
  "lsn_min": 4,
  "files": 1
}
select
[1]
[2]
[3]
[4]
(eof)
# test: wal write error
set error_wal to true
insert 5
error: (engine/write.c:108) error injection: error_wal
# test: wal write error #2
insert 4 xxx
error: (engine/write.c:108) error injection: error_wal
set error_wal to false
# test: wal write error #3
insert 8 zzz
select
[1]
[2]
[3]
[4]
[8, zzz]
(eof)
set error_wal to true
insert 4 xxx
error: (engine/write.c:108) error injection: error_wal
set error_wal to false
# test: select
show partitions debug
[{
  "min": 0,
  "max": 10,
  "created": "(filtered)",
  "events": 5,
  "events_heap": 1,
  "regions": 1,
  "size": 280,
  "size_uncompressed": 280,
  "size_heap": 2097152,
  "on_storage": true,
  "on_cloud": false,
  "storage": "main",
  "index": {
    "size": 74,
    "size_origin": 74,
    "size_regions": 92,
    "size_regions_origin": 92,
    "size_total": 280,
    "size_total_origin": 280,
    "regions": 1,
    "events": 4,
    "lsn": 4,
    "compression": 0
  }
}]
show wal
{
  "lsn": 5,
  "lsn_min": 4,
  "files": 1
}
select
[1]
[2]
[3]
[4]
[8, zzz]
(eof)
# test: restart
close
init
set workers to 0
set interval to 10
open
# test: select
show partitions debug
[{
  "min": 0,
  "max": 10,
  "created": "(filtered)",
  "events": 5,
  "events_heap": 1,
  "regions": 1,
  "size": 280,
  "size_uncompressed": 280,
  "size_heap": 2097152,
  "on_storage": true,
  "on_cloud": false,
  "storage": "main",
  "index": {
    "size": 74,
    "size_origin": 74,
    "size_regions": 92,
    "size_regions_origin": 92,
    "size_total": 280,
    "size_total_origin": 280,
    "regions": 1,
    "events": 4,
    "lsn": 4,
    "compression": 0
  }
}]
show wal
{
  "lsn": 5,
  "lsn_min": 4,
  "files": 1
}
select
[1]
[2]
[3]
[4]
[8, zzz]
(eof)
# test: insert
insert 7
insert 8
insert 9
# test: select
show partitions debug
[{
  "min": 0,
  "max": 10,
  "created": "(filtered)",
  "events": 7,
  "events_heap": 3,
  "regions": 1,
  "size": 280,
  "size_uncompressed": 280,
  "size_heap": 2097152,
  "on_storage": true,
  "on_cloud": false,
  "storage": "main",
  "index": {
    "size": 74,
    "size_origin": 74,
    "size_regions": 92,
    "size_regions_origin": 92,
    "size_total": 280,
    "size_total_origin": 280,
    "regions": 1,
    "events": 4,
    "lsn": 4,
    "compression": 0
  }
}]
show wal
{
  "lsn": 8,
  "lsn_min": 4,
  "files": 1
}
select
[1]
[2]
[3]
[4]
[7]
[8]
[9]
(eof)
# test: drop partition
drop partition 0
show partitions debug
[]
select
(eof)
debug "wal_read"
[4, 0, 1, 30]
[5, 0, 1, 33]
[6, 0, 1, 30]
[7, 0, 1, 30]
[8, 0, 1, 30]
[9, 1, 0, 25]

# test: restart
close
init
set workers to 0
set interval to 10
open
# test: ensure partition drop
show partitions debug
[]
select
(eof)
close
